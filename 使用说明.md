# SSH 密钥认证系统 - 使用说明

## 🚀 快速开始

### 第一步：安装依赖

```bash
npm install
```

**注意：** 根据您的要求，我们没有执行安装命令，请您稍后手动执行。

### 第二步：启动服务

**需要开启两个终端窗口：**

**终端 1 - 启动 SSH 认证服务：**
```bash
npm run start:auth
```
或
```bash
node auth-ssh-service.js
```

**终端 2 - 启动 Demo 应用：**
```bash
npm run start:demo
```
或
```bash
node demo-app.js
```

### 第三步：访问应用

打开浏览器访问：**http://localhost:4000**

## 📦 项目组成

### 两个独立服务

1. **SSH 认证服务** (`auth-ssh-service.js`)
   - 端口：SSH 2222 / HTTP 3000
   - 功能：提供 SSH 密钥认证 API
   - **可独立使用，集成到任何应用**

2. **Demo 应用** (`demo-app.js`)
   - 端口：4000
   - 功能：完整的用户系统演示
   - 包含：注册、登录、SSH 公钥管理

### 前端界面

- `public/index.html` - 完整的 Web 界面
- 功能：注册、密码登录、SSH 登录、公钥管理

## 📝 功能演示

### 1. 注册新用户

1. 访问 http://localhost:4000
2. 点击"注册"标签
3. 输入用户名（至少 3 个字符）
4. 输入密码（至少 6 个字符）
5. 点击"注册"按钮

### 2. 生成 SSH 密钥（如果还没有）

**Windows (PowerShell):**
```powershell
ssh-keygen -t rsa -b 4096
type $env:USERPROFILE\.ssh\id_rsa.pub
```

**Linux/Mac:**
```bash
ssh-keygen -t rsa -b 4096
cat ~/.ssh/id_rsa.pub
```

### 3. 添加 SSH 公钥

1. 使用密码登录系统
2. 在"SSH 公钥管理"区域
3. 输入密钥名称（例如："我的电脑"）
4. 粘贴您的 SSH 公钥
5. 点击"添加 SSH 公钥"

### 4. 体验 SSH 登录

1. 点击"退出登录"
2. 切换到"SSH 登录"标签
3. 输入用户名
4. 点击"通过 SSH 登录"
5. 复制显示的 SSH 命令
6. 在新终端窗口执行该命令
7. 浏览器自动完成登录！

## 📚 文档说明

| 文件 | 说明 | 适合人群 |
|------|------|----------|
| **README.md** | 完整项目文档 | 所有用户 |
| **QUICK_START.md** | 快速上手指南 | 新用户 |
| **API.md** | SSH 认证服务 API 文档 | 集成开发者 |
| **ARCHITECTURE.md** | 系统架构设计文档 | 深入学习者 |
| **EXAMPLES.md** | 代码示例（多种语言） | 开发者 |
| **TROUBLESHOOTING.md** | 故障排除指南 | 遇到问题时 |
| **PROJECT_SUMMARY.md** | 项目总结 | 全面了解 |
| **使用说明.md** | 简短中文说明（本文件） | 快速了解 |

## ⚙️ 环境变量配置

### SSH 认证服务

```bash
# Windows (PowerShell)
$env:SSH_PORT=2222
$env:HTTP_PORT=3000
node auth-ssh-service.js

# Linux/Mac
SSH_PORT=2222 HTTP_PORT=3000 node auth-ssh-service.js
```

### Demo 应用

```bash
# Windows (PowerShell)
$env:DEMO_PORT=4000
node demo-app.js

# Linux/Mac
DEMO_PORT=4000 node demo-app.js
```

## 🔧 常见问题

### 问题 1：端口被占用

**解决方案：** 修改端口
```bash
SSH_PORT=3022 HTTP_PORT=3001 node auth-ssh-service.js
```

### 问题 2：Windows 端口 22 权限问题

**解决方案：** 使用默认端口 2222，或以管理员身份运行

### 问题 3：验证码过期

**原因：** 验证码有效期 5 分钟

**解决方案：** 重新生成验证码

### 问题 4：公钥不匹配

**解决方案：** 
1. 确认添加的公钥正确
2. 确认 SSH 使用的是对应的私钥
3. 查看公钥：`cat ~/.ssh/id_rsa.pub`

### 问题 5：依赖安装失败

**Windows bcrypt 编译问题：**
```bash
npm install --global windows-build-tools
npm install
```

## 🌐 工作原理

```
1. 用户请求 SSH 登录
   ↓
2. 系统生成临时验证码（如：a1b2c3d4）
   ↓
3. 显示 SSH 命令：ssh a1b2c3d4@localhost -p 2222
   ↓
4. 用户在终端执行命令
   ↓
5. SSH 服务器提取用户的公钥
   ↓
6. 系统验证公钥是否匹配
   ↓
7. 验证成功，返回登录 Token
   ↓
8. 完成登录！
```

## 🔐 安全说明

- ✅ 密码使用 bcrypt 加密（永不明文存储）
- ✅ JWT 令牌认证（24 小时有效期）
- ✅ 验证码自动过期（5 分钟）
- ✅ SSH 公钥严格匹配验证
- ✅ 一次性验证码（使用后立即删除）

## 📋 项目结构

```
authViaPort22/
├── auth-ssh-service.js    # SSH 认证服务（独立）
├── demo-app.js            # Demo 应用（演示）
├── public/
│   └── index.html        # 前端界面
├── data/
│   └── users.json        # 用户数据（JSON 数据库）
├── package.json          # 依赖配置
└── 文档/
    ├── README.md         # 完整文档
    ├── API.md            # API 文档
    ├── QUICK_START.md    # 快速开始
    └── 其他文档...
```

## 🎯 核心特性

- ✅ **真实 SSH 服务器**：基于 ssh2 库，支持真实 SSH 连接
- ✅ **服务分离**：SSH 认证服务可独立部署和使用
- ✅ **完整 Demo**：包含用户系统的完整示例
- ✅ **现代化 UI**：美观的 Web 界面
- ✅ **安全可靠**：多重安全机制
- ✅ **易于集成**：RESTful API，详细文档
- ✅ **开箱即用**：无需额外配置

## 🚀 集成到您的项目

SSH 认证服务是**完全独立**的，可以集成到任何应用：

### 集成步骤

1. **生成验证码**
   ```javascript
   const response = await fetch('http://localhost:3000/api/auth/generate-code', {
     method: 'POST'
   });
   const { code, sshCommand } = await response.json();
   ```

2. **显示给用户**
   ```javascript
   console.log(`请执行: ${sshCommand}`);
   ```

3. **轮询获取公钥**
   ```javascript
   const result = await fetch(`http://localhost:3000/api/auth/verify/${code}`);
   const { status, publicKey } = await result.json();
   ```

4. **验证公钥并完成登录**

详细示例参考 `API.md` 和 `EXAMPLES.md`。

## 📞 获取帮助

- 查看 **README.md** - 完整文档
- 查看 **API.md** - API 详细说明
- 查看 **TROUBLESHOOTING.md** - 问题解决
- 查看 **EXAMPLES.md** - 代码示例

## 🎉 开始使用

```bash
# 1. 安装依赖
npm install

# 2. 启动 SSH 认证服务（终端 1）
npm run start:auth

# 3. 启动 Demo 应用（终端 2）
npm run start:demo

# 4. 打开浏览器
# http://localhost:4000
```

---

**祝您使用愉快！如有问题，请查看详细文档。** 📖

